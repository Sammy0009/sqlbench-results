AdaptiveSparkPlan isFinalPlan=true
+- == Final Plan ==
   GpuColumnarToRow false
   +- GpuTopN(limit=100, orderBy=[lochierarchy#25213 DESC NULLS LAST,CASE WHEN (lochierarchy#25213 = 0) THEN s_state#25315 END ASC NULLS FIRST,rank_within_parent#25214 ASC NULLS FIRST], output=[total_sum#25212,s_state#25315,s_county#25316,lochierarchy#25213,rank_within_parent#25214])
      +- GpuProject [total_sum#25212, s_state#25315, s_county#25316, lochierarchy#25213, rank_within_parent#25214], true
         +- GpuRunningWindow [total_sum#25212, s_state#25315, s_county#25316, lochierarchy#25213, _w1#25329, _w2#25330, _w3#25331, gpurank(_w3#25331) gpuwindowspecdefinition(_w1#25329, _w2#25330, _w3#25331 DESC NULLS LAST, gpuspecifiedwindowframe(RowFrame, gpuspecialframeboundary(unboundedpreceding$()), gpuspecialframeboundary(currentrow$()))) AS rank_within_parent#25214], [_w1#25329, _w2#25330], [_w3#25331 DESC NULLS LAST]
            +- GpuSort [_w1#25329 ASC NULLS FIRST, _w2#25330 ASC NULLS FIRST, _w3#25331 DESC NULLS LAST], false, com.nvidia.spark.rapids.OutOfCoreSort$@59d99269
               +- GpuRowToColumnar targetsize(2147483647)
                  +- AQEShuffleRead coalesced
                     +- ShuffleQueryStage 15
                        +- Exchange hashpartitioning(_w1#25329, _w2#25330, 200), ENSURE_REQUIREMENTS, [id=#430608]
                           +- *(1) HashAggregate(keys=[s_state#25315, s_county#25316, spark_grouping_id#25314L], functions=[sum(UnscaledValue(ss_net_profit#274))], output=[total_sum#25212, s_state#25315, s_county#25316, lochierarchy#25213, _w1#25329, _w2#25330, _w3#25331])
                              +- GpuColumnarToRow false
                                 +- GpuShuffleCoalesce 2147483647
                                    +- GpuCustomShuffleReader coalesced
                                       +- ShuffleQueryStage 14
                                          +- GpuColumnarExchange gpuhashpartitioning(s_state#25315, s_county#25316, spark_grouping_id#25314L, 200), ENSURE_REQUIREMENTS, [id=#430519]
                                             +- GpuHashAggregate(keys=[s_state#25315, s_county#25316, spark_grouping_id#25314L], functions=[partial_gpubasicsum(UnscaledValue(ss_net_profit#274), LongType, false)], output=[s_state#25315, s_county#25316, spark_grouping_id#25314L, sum#25350L])
                                                +- GpuExpand [[ss_net_profit#274, s_state#736, s_county#735, 0], [ss_net_profit#274, s_state#736, null, 1], [ss_net_profit#274, null, null, 3]], [ss_net_profit#274, s_state#25315, s_county#25316, spark_grouping_id#25314L]
                                                   +- GpuProject [ss_net_profit#274, s_state#736, s_county#735], true
                                                      +- GpuShuffledHashJoin [ss_sold_date_sk#252], [d_date_sk#612], Inner, GpuBuildRight, false
                                                         :- GpuShuffleCoalesce 2147483647
                                                         :  +- GpuCustomShuffleReader coalesced
                                                         :     +- ShuffleQueryStage 13
                                                         :        +- GpuColumnarExchange gpuhashpartitioning(ss_sold_date_sk#252, 200), ENSURE_REQUIREMENTS, [id=#430331]
                                                         :           +- GpuProject [ss_sold_date_sk#252, ss_net_profit#274, s_county#735, s_state#736], true
                                                         :              +- GpuShuffledHashJoin [ss_store_sk#259], [s_store_sk#712], Inner, GpuBuildRight, false
                                                         :                 :- GpuShuffleCoalesce 2147483647
                                                         :                 :  +- GpuCustomShuffleReader coalesced
                                                         :                 :     +- ShuffleQueryStage 0
                                                         :                 :        +- GpuColumnarExchange gpuhashpartitioning(ss_store_sk#259, 200), ENSURE_REQUIREMENTS, [id=#427621]
                                                         :                 :           +- GpuCoalesceBatches targetsize(2147483647)
                                                         :                 :              +- GpuFilter (gpuisnotnull(ss_store_sk#259) AND gpuisnotnull(ss_sold_date_sk#252)), true
                                                         :                 :                 +- GpuFileGpuScan parquet [ss_sold_date_sk#252,ss_store_sk#259,ss_net_profit#274] Batched: true, DataFilters: [isnotnull(ss_store_sk#259), isnotnull(ss_sold_date_sk#252)], Format: Parquet, Location: InMemoryFileIndex[file:/mnt/bigdata/tpcds/sf100-parquet/store_sales.parquet], PartitionFilters: [], PushedFilters: [IsNotNull(ss_store_sk), IsNotNull(ss_sold_date_sk)], ReadSchema: struct<ss_sold_date_sk:int,ss_store_sk:int,ss_net_profit:decimal(7,2)>
                                                         :                 +- GpuCustomShuffleReader coalesced
                                                         :                    +- ShuffleQueryStage 12
                                                         :                       +- GpuColumnarExchange gpuhashpartitioning(s_store_sk#712, 200), ENSURE_REQUIREMENTS, [id=#430117]
                                                         :                          +- GpuShuffledHashJoin [s_state#736], [s_state#25215], LeftSemi, GpuBuildRight, false
                                                         :                             :- GpuShuffleCoalesce 2147483647
                                                         :                             :  +- GpuCustomShuffleReader coalesced
                                                         :                             :     +- ShuffleQueryStage 1
                                                         :                             :        +- GpuColumnarExchange gpuhashpartitioning(s_state#736, 200), ENSURE_REQUIREMENTS, [id=#427649]
                                                         :                             :           +- GpuCoalesceBatches targetsize(2147483647)
                                                         :                             :              +- GpuFilter gpuisnotnull(s_store_sk#712), true
                                                         :                             :                 +- GpuFileGpuScan parquet [s_store_sk#712,s_county#735,s_state#736] Batched: true, DataFilters: [isnotnull(s_store_sk#712)], Format: Parquet, Location: InMemoryFileIndex[file:/mnt/bigdata/tpcds/sf100-parquet/store.parquet], PartitionFilters: [], PushedFilters: [IsNotNull(s_store_sk)], ReadSchema: struct<s_store_sk:int,s_county:string,s_state:string>
                                                         :                             +- GpuCustomShuffleReader coalesced
                                                         :                                +- ShuffleQueryStage 11
                                                         :                                   +- GpuColumnarExchange gpuhashpartitioning(s_state#25215, 200), ENSURE_REQUIREMENTS, [id=#429872]
                                                         :                                      +- GpuProject [s_state#25215], true
                                                         :                                         +- GpuCoalesceBatches targetsize(2147483647)
                                                         :                                            +- GpuFilter (ranking#25216 <= 5), true
                                                         :                                               +- GpuRunningWindow [s_state#25215, s_state#25277, _w1#25223, gpurank(_w1#25223) gpuwindowspecdefinition(s_state#25277, _w1#25223 DESC NULLS LAST, gpuspecifiedwindowframe(RowFrame, gpuspecialframeboundary(unboundedpreceding$()), gpuspecialframeboundary(currentrow$()))) AS ranking#25216], [s_state#25277], [_w1#25223 DESC NULLS LAST]
                                                         :                                                  +- GpuSort [s_state#25277 ASC NULLS FIRST, _w1#25223 DESC NULLS LAST], false, com.nvidia.spark.rapids.OutOfCoreSort$@59d99269
                                                         :                                                     +- GpuShuffleCoalesce 2147483647
                                                         :                                                        +- GpuCustomShuffleReader coalesced
                                                         :                                                           +- ShuffleQueryStage 10
                                                         :                                                              +- GpuColumnarExchange gpuhashpartitioning(s_state#25277, 200), ENSURE_REQUIREMENTS, [id=#429588]
                                                         :                                                                 +- GpuHashAggregate(keys=[s_state#25277], functions=[gpubasicsum(UnscaledValue(ss_net_profit#25252), LongType, false)], output=[s_state#25215, s_state#25277, _w1#25223])
                                                         :                                                                    +- GpuShuffleCoalesce 2147483647
                                                         :                                                                       +- GpuCustomShuffleReader coalesced
                                                         :                                                                          +- ShuffleQueryStage 9
                                                         :                                                                             +- GpuColumnarExchange gpuhashpartitioning(s_state#25277, 200), ENSURE_REQUIREMENTS, [id=#429307]
                                                         :                                                                                +- GpuHashAggregate(keys=[s_state#25277], functions=[partial_gpubasicsum(UnscaledValue(ss_net_profit#25252), LongType, false)], output=[s_state#25277, sum#25352L])
                                                         :                                                                                   +- GpuProject [ss_net_profit#25252, s_state#25277], true
                                                         :                                                                                      +- GpuShuffledHashJoin [ss_sold_date_sk#25230], [d_date_sk#25282], Inner, GpuBuildRight, false
                                                         :                                                                                         :- GpuShuffleCoalesce 2147483647
                                                         :                                                                                         :  +- GpuCustomShuffleReader coalesced
                                                         :                                                                                         :     +- ShuffleQueryStage 8
                                                         :                                                                                         :        +- GpuColumnarExchange gpuhashpartitioning(ss_sold_date_sk#25230, 200), ENSURE_REQUIREMENTS, [id=#428938]
                                                         :                                                                                         :           +- GpuProject [ss_sold_date_sk#25230, ss_net_profit#25252, s_state#25277], true
                                                         :                                                                                         :              +- GpuShuffledHashJoin [ss_store_sk#25237], [s_store_sk#25253], Inner, GpuBuildRight, false
                                                         :                                                                                         :                 :- GpuShuffleCoalesce 2147483647
                                                         :                                                                                         :                 :  +- GpuCustomShuffleReader coalesced
                                                         :                                                                                         :                 :     +- ShuffleQueryStage 3
                                                         :                                                                                         :                 :        +- ReusedExchange [ss_sold_date_sk#25230, ss_store_sk#25237, ss_net_profit#25252], GpuColumnarExchange gpuhashpartitioning(ss_store_sk#259, 200), ENSURE_REQUIREMENTS, [id=#427621]
                                                         :                                                                                         :                 +- GpuCustomShuffleReader coalesced
                                                         :                                                                                         :                    +- ShuffleQueryStage 4
                                                         :                                                                                         :                       +- GpuColumnarExchange gpuhashpartitioning(s_store_sk#25253, 200), ENSURE_REQUIREMENTS, [id=#427707]
                                                         :                                                                                         :                          +- GpuCoalesceBatches targetsize(2147483647)
                                                         :                                                                                         :                             +- GpuFilter gpuisnotnull(s_store_sk#25253), true
                                                         :                                                                                         :                                +- GpuFileGpuScan parquet [s_store_sk#25253,s_state#25277] Batched: true, DataFilters: [isnotnull(s_store_sk#25253)], Format: Parquet, Location: InMemoryFileIndex[file:/mnt/bigdata/tpcds/sf100-parquet/store.parquet], PartitionFilters: [], PushedFilters: [IsNotNull(s_store_sk)], ReadSchema: struct<s_store_sk:int,s_state:string>
                                                         :                                                                                         +- GpuCustomShuffleReader coalesced
                                                         :                                                                                            +- ShuffleQueryStage 5
                                                         :                                                                                               +- GpuColumnarExchange gpuhashpartitioning(d_date_sk#25282, 200), ENSURE_REQUIREMENTS, [id=#427748]
                                                         :                                                                                                  +- GpuProject [d_date_sk#25282], true
                                                         :                                                                                                     +- GpuCoalesceBatches targetsize(2147483647)
                                                         :                                                                                                        +- GpuFilter (((gpuisnotnull(d_month_seq#25285) AND (d_month_seq#25285 >= 1209)) AND (d_month_seq#25285 <= 1220)) AND gpuisnotnull(d_date_sk#25282)), true
                                                         :                                                                                                           +- GpuFileGpuScan parquet [d_date_sk#25282,d_month_seq#25285] Batched: true, DataFilters: [isnotnull(d_month_seq#25285), (d_month_seq#25285 >= 1209), (d_month_seq#25285 <= 1220), isnotnul..., Format: Parquet, Location: InMemoryFileIndex[file:/mnt/bigdata/tpcds/sf100-parquet/date_dim.parquet], PartitionFilters: [], PushedFilters: [IsNotNull(d_month_seq), GreaterThanOrEqual(d_month_seq,1209), LessThanOrEqual(d_month_seq,1220),..., ReadSchema: struct<d_date_sk:int,d_month_seq:int>
                                                         +- GpuCustomShuffleReader coalesced
                                                            +- ShuffleQueryStage 7
                                                               +- ReusedExchange [d_date_sk#612], GpuColumnarExchange gpuhashpartitioning(d_date_sk#25282, 200), ENSURE_REQUIREMENTS, [id=#427748]
+- == Initial Plan ==
   TakeOrderedAndProject(limit=100, orderBy=[lochierarchy#25213 DESC NULLS LAST,CASE WHEN (lochierarchy#25213 = 0) THEN s_state#25315 END ASC NULLS FIRST,rank_within_parent#25214 ASC NULLS FIRST], output=[total_sum#25212,s_state#25315,s_county#25316,lochierarchy#25213,rank_within_parent#25214])
   +- Project [total_sum#25212, s_state#25315, s_county#25316, lochierarchy#25213, rank_within_parent#25214]
      +- Window [rank(_w3#25331) windowspecdefinition(_w1#25329, _w2#25330, _w3#25331 DESC NULLS LAST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rank_within_parent#25214], [_w1#25329, _w2#25330], [_w3#25331 DESC NULLS LAST]
         +- Sort [_w1#25329 ASC NULLS FIRST, _w2#25330 ASC NULLS FIRST, _w3#25331 DESC NULLS LAST], false, 0
            +- Exchange hashpartitioning(_w1#25329, _w2#25330, 200), ENSURE_REQUIREMENTS, [id=#426820]
               +- HashAggregate(keys=[s_state#25315, s_county#25316, spark_grouping_id#25314L], functions=[sum(UnscaledValue(ss_net_profit#274))], output=[total_sum#25212, s_state#25315, s_county#25316, lochierarchy#25213, _w1#25329, _w2#25330, _w3#25331])
                  +- Exchange hashpartitioning(s_state#25315, s_county#25316, spark_grouping_id#25314L, 200), ENSURE_REQUIREMENTS, [id=#426817]
                     +- HashAggregate(keys=[s_state#25315, s_county#25316, spark_grouping_id#25314L], functions=[partial_sum(UnscaledValue(ss_net_profit#274))], output=[s_state#25315, s_county#25316, spark_grouping_id#25314L, sum#25350L])
                        +- Expand [[ss_net_profit#274, s_state#736, s_county#735, 0], [ss_net_profit#274, s_state#736, null, 1], [ss_net_profit#274, null, null, 3]], [ss_net_profit#274, s_state#25315, s_county#25316, spark_grouping_id#25314L]
                           +- Project [ss_net_profit#274, s_state#736, s_county#735]
                              +- SortMergeJoin [ss_sold_date_sk#252], [d_date_sk#612], Inner
                                 :- Sort [ss_sold_date_sk#252 ASC NULLS FIRST], false, 0
                                 :  +- Exchange hashpartitioning(ss_sold_date_sk#252, 200), ENSURE_REQUIREMENTS, [id=#426808]
                                 :     +- Project [ss_sold_date_sk#252, ss_net_profit#274, s_county#735, s_state#736]
                                 :        +- SortMergeJoin [ss_store_sk#259], [s_store_sk#712], Inner
                                 :           :- Sort [ss_store_sk#259 ASC NULLS FIRST], false, 0
                                 :           :  +- Exchange hashpartitioning(ss_store_sk#259, 200), ENSURE_REQUIREMENTS, [id=#426800]
                                 :           :     +- Filter (isnotnull(ss_store_sk#259) AND isnotnull(ss_sold_date_sk#252))
                                 :           :        +- FileScan parquet [ss_sold_date_sk#252,ss_store_sk#259,ss_net_profit#274] Batched: true, DataFilters: [isnotnull(ss_store_sk#259), isnotnull(ss_sold_date_sk#252)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/mnt/bigdata/tpcds/sf100-parquet/store_sales.parquet], PartitionFilters: [], PushedFilters: [IsNotNull(ss_store_sk), IsNotNull(ss_sold_date_sk)], ReadSchema: struct<ss_sold_date_sk:int,ss_store_sk:int,ss_net_profit:decimal(7,2)>
                                 :           +- Sort [s_store_sk#712 ASC NULLS FIRST], false, 0
                                 :              +- Exchange hashpartitioning(s_store_sk#712, 200), ENSURE_REQUIREMENTS, [id=#426801]
                                 :                 +- SortMergeJoin [s_state#736], [s_state#25215], LeftSemi
                                 :                    :- Sort [s_state#736 ASC NULLS FIRST], false, 0
                                 :                    :  +- Exchange hashpartitioning(s_state#736, 200), ENSURE_REQUIREMENTS, [id=#426793]
                                 :                    :     +- Filter isnotnull(s_store_sk#712)
                                 :                    :        +- FileScan parquet [s_store_sk#712,s_county#735,s_state#736] Batched: true, DataFilters: [isnotnull(s_store_sk#712)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/mnt/bigdata/tpcds/sf100-parquet/store.parquet], PartitionFilters: [], PushedFilters: [IsNotNull(s_store_sk)], ReadSchema: struct<s_store_sk:int,s_county:string,s_state:string>
                                 :                    +- Sort [s_state#25215 ASC NULLS FIRST], false, 0
                                 :                       +- Exchange hashpartitioning(s_state#25215, 200), ENSURE_REQUIREMENTS, [id=#426794]
                                 :                          +- Project [s_state#25215]
                                 :                             +- Filter (ranking#25216 <= 5)
                                 :                                +- Window [rank(_w1#25223) windowspecdefinition(s_state#25277, _w1#25223 DESC NULLS LAST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS ranking#25216], [s_state#25277], [_w1#25223 DESC NULLS LAST]
                                 :                                   +- Sort [s_state#25277 ASC NULLS FIRST, _w1#25223 DESC NULLS LAST], false, 0
                                 :                                      +- Exchange hashpartitioning(s_state#25277, 200), ENSURE_REQUIREMENTS, [id=#426786]
                                 :                                         +- HashAggregate(keys=[s_state#25277], functions=[sum(UnscaledValue(ss_net_profit#25252))], output=[s_state#25215, s_state#25277, _w1#25223])
                                 :                                            +- Exchange hashpartitioning(s_state#25277, 200), ENSURE_REQUIREMENTS, [id=#426783]
                                 :                                               +- HashAggregate(keys=[s_state#25277], functions=[partial_sum(UnscaledValue(ss_net_profit#25252))], output=[s_state#25277, sum#25352L])
                                 :                                                  +- Project [ss_net_profit#25252, s_state#25277]
                                 :                                                     +- SortMergeJoin [ss_sold_date_sk#25230], [d_date_sk#25282], Inner
                                 :                                                        :- Sort [ss_sold_date_sk#25230 ASC NULLS FIRST], false, 0
                                 :                                                        :  +- Exchange hashpartitioning(ss_sold_date_sk#25230, 200), ENSURE_REQUIREMENTS, [id=#426775]
                                 :                                                        :     +- Project [ss_sold_date_sk#25230, ss_net_profit#25252, s_state#25277]
                                 :                                                        :        +- SortMergeJoin [ss_store_sk#25237], [s_store_sk#25253], Inner
                                 :                                                        :           :- Sort [ss_store_sk#25237 ASC NULLS FIRST], false, 0
                                 :                                                        :           :  +- Exchange hashpartitioning(ss_store_sk#25237, 200), ENSURE_REQUIREMENTS, [id=#426767]
                                 :                                                        :           :     +- Filter (isnotnull(ss_store_sk#25237) AND isnotnull(ss_sold_date_sk#25230))
                                 :                                                        :           :        +- FileScan parquet [ss_sold_date_sk#25230,ss_store_sk#25237,ss_net_profit#25252] Batched: true, DataFilters: [isnotnull(ss_store_sk#25237), isnotnull(ss_sold_date_sk#25230)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/mnt/bigdata/tpcds/sf100-parquet/store_sales.parquet], PartitionFilters: [], PushedFilters: [IsNotNull(ss_store_sk), IsNotNull(ss_sold_date_sk)], ReadSchema: struct<ss_sold_date_sk:int,ss_store_sk:int,ss_net_profit:decimal(7,2)>
                                 :                                                        :           +- Sort [s_store_sk#25253 ASC NULLS FIRST], false, 0
                                 :                                                        :              +- Exchange hashpartitioning(s_store_sk#25253, 200), ENSURE_REQUIREMENTS, [id=#426768]
                                 :                                                        :                 +- Filter isnotnull(s_store_sk#25253)
                                 :                                                        :                    +- FileScan parquet [s_store_sk#25253,s_state#25277] Batched: true, DataFilters: [isnotnull(s_store_sk#25253)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/mnt/bigdata/tpcds/sf100-parquet/store.parquet], PartitionFilters: [], PushedFilters: [IsNotNull(s_store_sk)], ReadSchema: struct<s_store_sk:int,s_state:string>
                                 :                                                        +- Sort [d_date_sk#25282 ASC NULLS FIRST], false, 0
                                 :                                                           +- Exchange hashpartitioning(d_date_sk#25282, 200), ENSURE_REQUIREMENTS, [id=#426776]
                                 :                                                              +- Project [d_date_sk#25282]
                                 :                                                                 +- Filter (((isnotnull(d_month_seq#25285) AND (d_month_seq#25285 >= 1209)) AND (d_month_seq#25285 <= 1220)) AND isnotnull(d_date_sk#25282))
                                 :                                                                    +- FileScan parquet [d_date_sk#25282,d_month_seq#25285] Batched: true, DataFilters: [isnotnull(d_month_seq#25285), (d_month_seq#25285 >= 1209), (d_month_seq#25285 <= 1220), isnotnul..., Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/mnt/bigdata/tpcds/sf100-parquet/date_dim.parquet], PartitionFilters: [], PushedFilters: [IsNotNull(d_month_seq), GreaterThanOrEqual(d_month_seq,1209), LessThanOrEqual(d_month_seq,1220),..., ReadSchema: struct<d_date_sk:int,d_month_seq:int>
                                 +- Sort [d_date_sk#612 ASC NULLS FIRST], false, 0
                                    +- Exchange hashpartitioning(d_date_sk#612, 200), ENSURE_REQUIREMENTS, [id=#426809]
                                       +- Project [d_date_sk#612]
                                          +- Filter (((isnotnull(d_month_seq#615) AND (d_month_seq#615 >= 1209)) AND (d_month_seq#615 <= 1220)) AND isnotnull(d_date_sk#612))
                                             +- FileScan parquet [d_date_sk#612,d_month_seq#615] Batched: true, DataFilters: [isnotnull(d_month_seq#615), (d_month_seq#615 >= 1209), (d_month_seq#615 <= 1220), isnotnull(d_da..., Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/mnt/bigdata/tpcds/sf100-parquet/date_dim.parquet], PartitionFilters: [], PushedFilters: [IsNotNull(d_month_seq), GreaterThanOrEqual(d_month_seq,1209), LessThanOrEqual(d_month_seq,1220),..., ReadSchema: struct<d_date_sk:int,d_month_seq:int>
