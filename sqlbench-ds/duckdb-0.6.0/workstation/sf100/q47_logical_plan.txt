┌─────────────────┐                                                                                                                                                                                                                 
│    PROJECTION   │                                                                                                                                                                                                                 
│   ─ ─ ─ ─ ─ ─   │                                                                                                                                                                                                                 
│        #0       │                                                                                                                                                                                                                 
│        #1       │                                                                                                                                                                                                                 
│        #2       │                                                                                                                                                                                                                 
│        #3       │                                                                                                                                                                                                                 
│        #4       │                                                                                                                                                                                                                 
│        #5       │                                                                                                                                                                                                                 
│        #6       │                                                                                                                                                                                                                 
│        #7       │                                                                                                                                                                                                                 
└────────┬────────┘                                                                                                                                                                                                                                    
┌────────┴────────┐                                                                                                                                                                                                                 
│      TOP_N      │                                                                                                                                                                                                                 
│   ─ ─ ─ ─ ─ ─   │                                                                                                                                                                                                                 
│     Top 100     │                                                                                                                                                                                                                 
│   ─ ─ ─ ─ ─ ─   │                                                                                                                                                                                                                 
│      #8 ASC     │                                                                                                                                                                                                                 
│   v2.psum ASC   │                                                                                                                                                                                                                 
└────────┬────────┘                                                                                                                                                                                                                                    
┌────────┴────────┐                                                                                                                                                                                                                 
│    PROJECTION   │                                                                                                                                                                                                                 
│   ─ ─ ─ ─ ─ ─   │                                                                                                                                                                                                                 
│    i_category   │                                                                                                                                                                                                                 
│     i_brand     │                                                                                                                                                                                                                 
│      d_year     │                                                                                                                                                                                                                 
│      d_moy      │                                                                                                                                                                                                                 
│avg_monthly_sales│                                                                                                                                                                                                                 
│    sum_sales    │                                                                                                                                                                                                                 
│       psum      │                                                                                                                                                                                                                 
│       nsum      │                                                                                                                                                                                                                 
│ (CAST(sum_sales │                                                                                                                                                                                                                 
│   AS DOUBLE) -  │                                                                                                                                                                                                                 
│ avg_monthly...  │                                                                                                                                                                                                                 
└────────┬────────┘                                                                                                                                                                                                                                    
┌────────┴────────┐                                                                                                                                                                                                                 
│    PROJECTION   │                                                                                                                                                                                                                 
│   ─ ─ ─ ─ ─ ─   │                                                                                                                                                                                                                 
│    i_category   │                                                                                                                                                                                                                 
│     i_brand     │                                                                                                                                                                                                                 
│      d_year     │                                                                                                                                                                                                                 
│      d_moy      │                                                                                                                                                                                                                 
│avg_monthly_sales│                                                                                                                                                                                                                 
│    sum_sales    │                                                                                                                                                                                                                 
│       psum      │                                                                                                                                                                                                                 
│       nsum      │                                                                                                                                                                                                                 
└────────┬────────┘                                                                                                                                                                                                                                    
┌────────┴────────┐                                                                                                                                                                                                                 
│    HASH_JOIN    │                                                                                                                                                                                                                 
│   ─ ─ ─ ─ ─ ─   │                                                                                                                                                                                                                 
│      INNER      │                                                                                                                                                                                                                 
│  rn = (rn + 1)  │                                                                                                                                                                                                                 
│ s_company_name =│                                                                                                                                                                                                                 
│  s_company_name │                                                                                                                                                                                                                 
│   i_category =  │                                                                                                                                                                                                                 
│    i_category   │                                                                                                                                                                                                                 
│i_brand = i_brand│                                                                                                                                                                                                                 
│  s_store_name = │                                                                                                                                                                                                                 
│   s_store_name  │                                                                                                                                                                                                                 
│  rn = (rn - 1)  ├──────────────────────────────────────────────────────────────────┐                                                                                                                                              
│ s_company_name =│                                                                  │                                                                                                                                              
│  s_company_name │                                                                  │                                                                                                                                              
│   i_category =  │                                                                  │                                                                                                                                              
│    i_category   │                                                                  │                                                                                                                                              
│i_brand = i_brand│                                                                  │                                                                                                                                              
│  s_store_name = │                                                                  │                                                                                                                                              
│   s_store_name  │                                                                  │                                                                                                                                              
│  EC = 287997143 │                                                                  │                                                                                                                                              
│     .000000     │                                                                  │                                                                                                                                              
│ COST = 575994286│                                                                  │                                                                                                                                              
│     .000000     │                                                                  │                                                                                                                                              
└────────┬────────┘                                                                  │                                                                                                                                                                 
┌────────┴────────┐                                                         ┌────────┴────────┐                                                                                                                                     
│      FILTER     │                                                         │    HASH_JOIN    │                                                                                                                                     
│   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                                                                                                     
│ ((d_year = 2000)│                                                         │      INNER      │                                                                                                                                     
│ AND (avg_mo...  │                                                         │ (rn + 1) = (rn -│                                                                                                                                     
│sales > 0.0) AND │                                                         │        1)       │                                                                                                                                     
│  (CASE  WHEN (  │                                                         │ s_company_name =│                                                                                                                                     
│(avg_monthly...  │                                                         │  s_company_name │                                                                                                                                     
│ 0.0)) THEN ...  │                                                         │   i_category =  │                                                                                                                                     
│ (CAST(sum_sales │                                                         │    i_category   ├──────────────────────────────────────────────────────────────────┐                                                                  
│   AS DOUBLE) -  │                                                         │i_brand = i_brand│                                                                  │                                                                  
│ avg_monthly...  │                                                         │  s_store_name = │                                                                  │                                                                  
│ avg_monthly...  │                                                         │   s_store_name  │                                                                  │                                                                  
│)) ELSE NULL END │                                                         │  EC = 287997143 │                                                                  │                                                                  
│     > 0.1))     │                                                         │     .000000     │                                                                  │                                                                  
│                 │                                                         │ COST = 287997143│                                                                  │                                                                  
│                 │                                                         │     .000000     │                                                                  │                                                                  
└────────┬────────┘                                                         └────────┬────────┘                                                                  │                                                                                     
┌────────┴────────┐                                                         ┌────────┴────────┐                                                         ┌────────┴────────┐                                                         
│    PROJECTION   │                                                         │    PROJECTION   │                                                         │    PROJECTION   │                                                         
│   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         
│        #0       │                                                         │    i_category   │                                                         │    i_category   │                                                         
│        #1       │                                                         │     i_brand     │                                                         │     i_brand     │                                                         
│        #2       │                                                         │   s_store_name  │                                                         │   s_store_name  │                                                         
│        #3       │                                                         │  s_company_name │                                                         │  s_company_name │                                                         
│        #4       │                                                         │    sum_sales    │                                                         │    sum_sales    │                                                         
│        #5       │                                                         │        rn       │                                                         │        rn       │                                                         
│        #6       │                                                         │                 │                                                         │                 │                                                         
│        #7       │                                                         │                 │                                                         │                 │                                                         
│        #8       │                                                         │                 │                                                         │                 │                                                         
└────────┬────────┘                                                         └────────┬────────┘                                                         └────────┬────────┘                                                                            
┌────────┴────────┐                                                         ┌────────┴────────┐                                                         ┌────────┴────────┐                                                         
│      WINDOW     │                                                         │    PROJECTION   │                                                         │    PROJECTION   │                                                         
│   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         
│   RANK() OVER   │                                                         │        #0       │                                                         │        #0       │                                                         
│  (PARTITION BY  │                                                         │        #1       │                                                         │        #1       │                                                         
│ i_category,...  │                                                         │        #2       │                                                         │        #2       │                                                         
│   s_store_name, │                                                         │        #3       │                                                         │        #3       │                                                         
│ s_company_n...  │                                                         │        #4       │                                                         │        #4       │                                                         
│ d_year ASC NULLS│                                                         │        #5       │                                                         │        #5       │                                                         
│ FIRST, d_moy ASC│                                                         │        #6       │                                                         │        #6       │                                                         
│   NULLS FIRST)  │                                                         │        #7       │                                                         │        #7       │                                                         
│                 │                                                         │        #8       │                                                         │        #8       │                                                         
└────────┬────────┘                                                         └────────┬────────┘                                                         └────────┬────────┘                                                                            
┌────────┴────────┐                                                         ┌────────┴────────┐                                                         ┌────────┴────────┐                                                         
│      WINDOW     │                                                         │      WINDOW     │                                                         │      WINDOW     │                                                         
│   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         
│avg(sum(ss_sales_│                                                         │   RANK() OVER   │                                                         │   RANK() OVER   │                                                         
│  price)) OVER   │                                                         │  (PARTITION BY  │                                                         │  (PARTITION BY  │                                                         
│  (PARTITION BY  │                                                         │ i_category,...  │                                                         │ i_category,...  │                                                         
│ i_category,...  │                                                         │   s_store_name, │                                                         │   s_store_name, │                                                         
│   s_store_name, │                                                         │ s_company_n...  │                                                         │ s_company_n...  │                                                         
│ s_company_n...  │                                                         │ d_year ASC NULLS│                                                         │ d_year ASC NULLS│                                                         
│                 │                                                         │ FIRST, d_moy ASC│                                                         │ FIRST, d_moy ASC│                                                         
│                 │                                                         │   NULLS FIRST)  │                                                         │   NULLS FIRST)  │                                                         
└────────┬────────┘                                                         └────────┬────────┘                                                         └────────┬────────┘                                                                            
┌────────┴────────┐                                                         ┌────────┴────────┐                                                         ┌────────┴────────┐                                                         
│  HASH_GROUP_BY  │                                                         │      WINDOW     │                                                         │      WINDOW     │                                                         
│   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         
│        #0       │                                                         │avg(sum(ss_sales_│                                                         │avg(sum(ss_sales_│                                                         
│        #1       │                                                         │  price)) OVER   │                                                         │  price)) OVER   │                                                         
│        #2       │                                                         │  (PARTITION BY  │                                                         │  (PARTITION BY  │                                                         
│        #3       │                                                         │ i_category,...  │                                                         │ i_category,...  │                                                         
│        #4       │                                                         │   s_store_name, │                                                         │   s_store_name, │                                                         
│        #5       │                                                         │ s_company_n...  │                                                         │ s_company_n...  │                                                         
│     sum(#6)     │                                                         │                 │                                                         │                 │                                                         
└────────┬────────┘                                                         └────────┬────────┘                                                         └────────┬────────┘                                                                            
┌────────┴────────┐                                                         ┌────────┴────────┐                                                         ┌────────┴────────┐                                                         
│    PROJECTION   │                                                         │  HASH_GROUP_BY  │                                                         │  HASH_GROUP_BY  │                                                         
│   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         
│    i_category   │                                                         │        #0       │                                                         │        #0       │                                                         
│     i_brand     │                                                         │        #1       │                                                         │        #1       │                                                         
│   s_store_name  │                                                         │        #2       │                                                         │        #2       │                                                         
│  s_company_name │                                                         │        #3       │                                                         │        #3       │                                                         
│      d_year     │                                                         │        #4       │                                                         │        #4       │                                                         
│      d_moy      │                                                         │        #5       │                                                         │        #5       │                                                         
│  ss_sales_price │                                                         │     sum(#6)     │                                                         │     sum(#6)     │                                                         
└────────┬────────┘                                                         └────────┬────────┘                                                         └────────┬────────┘                                                                            
┌────────┴────────┐                                                         ┌────────┴────────┐                                                         ┌────────┴────────┐                                                         
│    HASH_JOIN    │                                                         │    PROJECTION   │                                                         │    PROJECTION   │                                                         
│   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         
│      INNER      │                                                         │    i_category   │                                                         │    i_category   │                                                         
│   ss_item_sk =  │                                                         │     i_brand     │                                                         │     i_brand     │                                                         
│     i_item_sk   ├───────────────────────────────────────────────┐         │   s_store_name  │                                                         │   s_store_name  │                                                         
│  EC = 287997144 │                                               │         │  s_company_name │                                                         │  s_company_name │                                                         
│     .000000     │                                               │         │      d_year     │                                                         │      d_year     │                                                         
│ COST = 863991432│                                               │         │      d_moy      │                                                         │      d_moy      │                                                         
│     .000000     │                                               │         │  ss_sales_price │                                                         │  ss_sales_price │                                                         
└────────┬────────┘                                               │         └────────┬────────┘                                                         └────────┬────────┘                                                                            
┌────────┴────────┐                                      ┌────────┴────────┐┌────────┴────────┐                                                         ┌────────┴────────┐                                                         
│    HASH_JOIN    │                                      │   PARQUET_SCAN  ││    HASH_JOIN    │                                                         │    HASH_JOIN    │                                                         
│   ─ ─ ─ ─ ─ ─   │                                      │   ─ ─ ─ ─ ─ ─   ││   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         
│      INNER      │                                      │    i_item_sk    ││      INNER      │                                                         │      INNER      │                                                         
│  ss_store_sk =  │                                      │     i_brand     ││   ss_item_sk =  │                                                         │   ss_item_sk =  │                                                         
│    s_store_sk   ├────────────────────────────┐         │    i_category   ││     i_item_sk   ├───────────────────────────────────────────────┐         │     i_item_sk   ├───────────────────────────────────────────────┐         
│  EC = 287997144 │                            │         │    EC=202300    ││  EC = 287997144 │                                               │         │  EC = 287997144 │                                               │         
│     .000000     │                            │         │                 ││     .000000     │                                               │         │     .000000     │                                               │         
│ COST = 575994288│                            │         │                 ││ COST = 863991432│                                               │         │ COST = 863991432│                                               │         
│     .000000     │                            │         │                 ││     .000000     │                                               │         │     .000000     │                                               │         
└────────┬────────┘                            │         └─────────────────┘└────────┬────────┘                                               │         └────────┬────────┘                                               │                            
┌────────┴────────┐                   ┌────────┴────────┐                   ┌────────┴────────┐                                      ┌────────┴────────┐┌────────┴────────┐                                      ┌────────┴────────┐
│    HASH_JOIN    │                   │   PARQUET_SCAN  │                   │    HASH_JOIN    │                                      │   PARQUET_SCAN  ││    HASH_JOIN    │                                      │   PARQUET_SCAN  │
│   ─ ─ ─ ─ ─ ─   │                   │   ─ ─ ─ ─ ─ ─   │                   │   ─ ─ ─ ─ ─ ─   │                                      │   ─ ─ ─ ─ ─ ─   ││   ─ ─ ─ ─ ─ ─   │                                      │   ─ ─ ─ ─ ─ ─   │
│      INNER      │                   │    s_store_sk   │                   │      INNER      │                                      │    i_item_sk    ││      INNER      │                                      │    i_item_sk    │
│ss_sold_date_sk =│                   │   s_store_name  │                   │  ss_store_sk =  │                                      │     i_brand     ││  ss_store_sk =  │                                      │     i_brand     │
│     d_date_sk   ├─────────┐         │  s_company_name │                   │    s_store_sk   ├────────────────────────────┐         │    i_category   ││    s_store_sk   ├────────────────────────────┐         │    i_category   │
│  EC = 287997144 │         │         │      EC=402     │                   │  EC = 287997144 │                            │         │    EC=202300    ││  EC = 287997144 │                            │         │    EC=202300    │
│     .000000     │         │         │                 │                   │     .000000     │                            │         │                 ││     .000000     │                            │         │                 │
│ COST = 287997144│         │         │                 │                   │ COST = 575994288│                            │         │                 ││ COST = 575994288│                            │         │                 │
│     .000000     │         │         │                 │                   │     .000000     │                            │         │                 ││     .000000     │                            │         │                 │
└────────┬────────┘         │         └─────────────────┘                   └────────┬────────┘                            │         └─────────────────┘└────────┬────────┘                            │         └─────────────────┘                   
┌────────┴────────┐┌────────┴────────┐                                      ┌────────┴────────┐                   ┌────────┴────────┐                   ┌────────┴────────┐                   ┌────────┴────────┐                   
│   PARQUET_SCAN  ││      FILTER     │                                      │    HASH_JOIN    │                   │   PARQUET_SCAN  │                   │    HASH_JOIN    │                   │   PARQUET_SCAN  │                   
│   ─ ─ ─ ─ ─ ─   ││   ─ ─ ─ ─ ─ ─   │                                      │   ─ ─ ─ ─ ─ ─   │                   │   ─ ─ ─ ─ ─ ─   │                   │   ─ ─ ─ ─ ─ ─   │                   │   ─ ─ ─ ─ ─ ─   │                   
│ ss_sold_date_sk ││ ((d_year = 2000)│                                      │      INNER      │                   │    s_store_sk   │                   │      INNER      │                   │    s_store_sk   │                   
│    ss_item_sk   ││   OR ((d_year = │                                      │ss_sold_date_sk =│                   │   s_store_name  │                   │ss_sold_date_sk =│                   │   s_store_name  │                   
│   ss_store_sk   ││ 1999) AND (...  │                                      │     d_date_sk   ├─────────┐         │  s_company_name │                   │     d_date_sk   ├─────────┐         │  s_company_name │                   
│  ss_sales_price ││ 12)) OR ((d...  │                                      │  EC = 287997144 │         │         │      EC=402     │                   │  EC = 287997144 │         │         │      EC=402     │                   
│   EC=287997144  ││ 2001) AND (d_moy│                                      │     .000000     │         │         │                 │                   │     .000000     │         │         │                 │                   
│                 ││      = 1)))     │                                      │ COST = 287997144│         │         │                 │                   │ COST = 287997144│         │         │                 │                   
│                 ││                 │                                      │     .000000     │         │         │                 │                   │     .000000     │         │         │                 │                   
└─────────────────┘└────────┬────────┘                                      └────────┬────────┘         │         └─────────────────┘                   └────────┬────────┘         │         └─────────────────┘                                      
                   ┌────────┴────────┐                                      ┌────────┴────────┐┌────────┴────────┐                                      ┌────────┴────────┐┌────────┴────────┐                                      
                   │   PARQUET_SCAN  │                                      │   PARQUET_SCAN  ││      FILTER     │                                      │   PARQUET_SCAN  ││      FILTER     │                                      
                   │   ─ ─ ─ ─ ─ ─   │                                      │   ─ ─ ─ ─ ─ ─   ││   ─ ─ ─ ─ ─ ─   │                                      │   ─ ─ ─ ─ ─ ─   ││   ─ ─ ─ ─ ─ ─   │                                      
                   │    d_date_sk    │                                      │ ss_sold_date_sk ││ ((d_year = 2000)│                                      │ ss_sold_date_sk ││ ((d_year = 2000)│                                      
                   │      d_year     │                                      │    ss_item_sk   ││   OR ((d_year = │                                      │    ss_item_sk   ││   OR ((d_year = │                                      
                   │      d_moy      │                                      │   ss_store_sk   ││ 1999) AND (...  │                                      │   ss_store_sk   ││ 1999) AND (...  │                                      
                   │     EC=40590    │                                      │  ss_sales_price ││ 12)) OR ((d...  │                                      │  ss_sales_price ││ 12)) OR ((d...  │                                      
                   │                 │                                      │   EC=287997144  ││ 2001) AND (d_moy│                                      │   EC=287997144  ││ 2001) AND (d_moy│                                      
                   │                 │                                      │                 ││      = 1)))     │                                      │                 ││      = 1)))     │                                      
                   └─────────────────┘                                      └─────────────────┘└────────┬────────┘                                      └─────────────────┘└────────┬────────┘                                                         
                                                                                               ┌────────┴────────┐                                                         ┌────────┴────────┐                                      
                                                                                               │   PARQUET_SCAN  │                                                         │   PARQUET_SCAN  │                                      
                                                                                               │   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                      
                                                                                               │    d_date_sk    │                                                         │    d_date_sk    │                                      
                                                                                               │      d_year     │                                                         │      d_year     │                                      
                                                                                               │      d_moy      │                                                         │      d_moy      │                                      
                                                                                               │     EC=40590    │                                                         │     EC=40590    │                                      
                                                                                               └─────────────────┘                                                         └─────────────────┘                                                         

