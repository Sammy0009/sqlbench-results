┌─────────────────┐                                                                                                                                                                                                                 
│    PROJECTION   │                                                                                                                                                                                                                 
│   ─ ─ ─ ─ ─ ─   │                                                                                                                                                                                                                 
│        #0       │                                                                                                                                                                                                                 
│        #1       │                                                                                                                                                                                                                 
│        #2       │                                                                                                                                                                                                                 
│        #3       │                                                                                                                                                                                                                 
│        #4       │                                                                                                                                                                                                                 
│        #5       │                                                                                                                                                                                                                 
└────────┬────────┘                                                                                                                                                                                                                                    
┌────────┴────────┐                                                                                                                                                                                                                 
│      TOP_N      │                                                                                                                                                                                                                 
│   ─ ─ ─ ─ ─ ─   │                                                                                                                                                                                                                 
│     Top 100     │                                                                                                                                                                                                                 
│   ─ ─ ─ ─ ─ ─   │                                                                                                                                                                                                                 
│      #6 ASC     │                                                                                                                                                                                                                 
│   v2.psum ASC   │                                                                                                                                                                                                                 
└────────┬────────┘                                                                                                                                                                                                                                    
┌────────┴────────┐                                                                                                                                                                                                                 
│    PROJECTION   │                                                                                                                                                                                                                 
│   ─ ─ ─ ─ ─ ─   │                                                                                                                                                                                                                 
│     cc_name     │                                                                                                                                                                                                                 
│      d_year     │                                                                                                                                                                                                                 
│avg_monthly_sales│                                                                                                                                                                                                                 
│    sum_sales    │                                                                                                                                                                                                                 
│       psum      │                                                                                                                                                                                                                 
│       nsum      │                                                                                                                                                                                                                 
│ (CAST(sum_sales │                                                                                                                                                                                                                 
│   AS DOUBLE) -  │                                                                                                                                                                                                                 
│ avg_monthly...  │                                                                                                                                                                                                                 
└────────┬────────┘                                                                                                                                                                                                                                    
┌────────┴────────┐                                                                                                                                                                                                                 
│    PROJECTION   │                                                                                                                                                                                                                 
│   ─ ─ ─ ─ ─ ─   │                                                                                                                                                                                                                 
│     cc_name     │                                                                                                                                                                                                                 
│      d_year     │                                                                                                                                                                                                                 
│avg_monthly_sales│                                                                                                                                                                                                                 
│    sum_sales    │                                                                                                                                                                                                                 
│       psum      │                                                                                                                                                                                                                 
│       nsum      │                                                                                                                                                                                                                 
└────────┬────────┘                                                                                                                                                                                                                                    
┌────────┴────────┐                                                                                                                                                                                                                 
│    HASH_JOIN    │                                                                                                                                                                                                                 
│   ─ ─ ─ ─ ─ ─   │                                                                                                                                                                                                                 
│      INNER      │                                                                                                                                                                                                                 
│  rn = (rn + 1)  │                                                                                                                                                                                                                 
│   i_category =  │                                                                                                                                                                                                                 
│    i_category   │                                                                                                                                                                                                                 
│i_brand = i_brand│                                                                                                                                                                                                                 
│cc_name = cc_name│                                                                                                                                                                                                                 
│  rn = (rn - 1)  ├──────────────────────────────────────────────────────────────────┐                                                                                                                                              
│   i_category =  │                                                                  │                                                                                                                                              
│    i_category   │                                                                  │                                                                                                                                              
│i_brand = i_brand│                                                                  │                                                                                                                                              
│cc_name = cc_name│                                                                  │                                                                                                                                              
│  EC = 143997928 │                                                                  │                                                                                                                                              
│     .000000     │                                                                  │                                                                                                                                              
│ COST = 287995856│                                                                  │                                                                                                                                              
│     .000000     │                                                                  │                                                                                                                                              
└────────┬────────┘                                                                  │                                                                                                                                                                 
┌────────┴────────┐                                                         ┌────────┴────────┐                                                                                                                                     
│    PROJECTION   │                                                         │    HASH_JOIN    │                                                                                                                                     
│   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                                                                                                     
│        #0       │                                                         │      INNER      │                                                                                                                                     
│        #1       │                                                         │ (rn + 1) = (rn -│                                                                                                                                     
│        #2       │                                                         │        1)       │                                                                                                                                     
│        #3       │                                                         │   i_category =  │                                                                                                                                     
│        #5       │                                                         │    i_category   ├──────────────────────────────────────────────────────────────────┐                                                                  
│        #6       │                                                         │i_brand = i_brand│                                                                  │                                                                  
│        #7       │                                                         │cc_name = cc_name│                                                                  │                                                                  
│                 │                                                         │  EC = 143997928 │                                                                  │                                                                  
│                 │                                                         │     .000000     │                                                                  │                                                                  
│                 │                                                         │ COST = 143997928│                                                                  │                                                                  
│                 │                                                         │     .000000     │                                                                  │                                                                  
└────────┬────────┘                                                         └────────┬────────┘                                                                  │                                                                                     
┌────────┴────────┐                                                         ┌────────┴────────┐                                                         ┌────────┴────────┐                                                         
│      FILTER     │                                                         │    PROJECTION   │                                                         │    PROJECTION   │                                                         
│   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         
│ ((d_year = 1999)│                                                         │    i_category   │                                                         │    i_category   │                                                         
│ AND (avg_mo...  │                                                         │     i_brand     │                                                         │     i_brand     │                                                         
│sales > 0.0) AND │                                                         │     cc_name     │                                                         │     cc_name     │                                                         
│  (CASE  WHEN (  │                                                         │    sum_sales    │                                                         │    sum_sales    │                                                         
│(avg_monthly...  │                                                         │        rn       │                                                         │        rn       │                                                         
│ 0.0)) THEN ...  │                                                         │                 │                                                         │                 │                                                         
│ (CAST(sum_sales │                                                         │                 │                                                         │                 │                                                         
│   AS DOUBLE) -  │                                                         │                 │                                                         │                 │                                                         
│ avg_monthly...  │                                                         │                 │                                                         │                 │                                                         
│ avg_monthly...  │                                                         │                 │                                                         │                 │                                                         
│)) ELSE NULL END │                                                         │                 │                                                         │                 │                                                         
│     > 0.1))     │                                                         │                 │                                                         │                 │                                                         
└────────┬────────┘                                                         └────────┬────────┘                                                         └────────┬────────┘                                                                            
┌────────┴────────┐                                                         ┌────────┴────────┐                                                         ┌────────┴────────┐                                                         
│    PROJECTION   │                                                         │    PROJECTION   │                                                         │    PROJECTION   │                                                         
│   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         
│        #0       │                                                         │        #0       │                                                         │        #0       │                                                         
│        #1       │                                                         │        #1       │                                                         │        #1       │                                                         
│        #2       │                                                         │        #2       │                                                         │        #2       │                                                         
│        #3       │                                                         │        #3       │                                                         │        #3       │                                                         
│        #4       │                                                         │        #4       │                                                         │        #4       │                                                         
│        #5       │                                                         │        #5       │                                                         │        #5       │                                                         
│        #6       │                                                         │        #6       │                                                         │        #6       │                                                         
│        #7       │                                                         │        #7       │                                                         │        #7       │                                                         
└────────┬────────┘                                                         └────────┬────────┘                                                         └────────┬────────┘                                                                            
┌────────┴────────┐                                                         ┌────────┴────────┐                                                         ┌────────┴────────┐                                                         
│      WINDOW     │                                                         │      WINDOW     │                                                         │      WINDOW     │                                                         
│   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         
│   RANK() OVER   │                                                         │   RANK() OVER   │                                                         │   RANK() OVER   │                                                         
│  (PARTITION BY  │                                                         │  (PARTITION BY  │                                                         │  (PARTITION BY  │                                                         
│ i_category,...  │                                                         │ i_category,...  │                                                         │ i_category,...  │                                                         
│ cc_name ORDER BY│                                                         │ cc_name ORDER BY│                                                         │ cc_name ORDER BY│                                                         
│ d_year ASC NULLS│                                                         │ d_year ASC NULLS│                                                         │ d_year ASC NULLS│                                                         
│ FIRST, d_moy ASC│                                                         │ FIRST, d_moy ASC│                                                         │ FIRST, d_moy ASC│                                                         
│   NULLS FIRST)  │                                                         │   NULLS FIRST)  │                                                         │   NULLS FIRST)  │                                                         
└────────┬────────┘                                                         └────────┬────────┘                                                         └────────┬────────┘                                                                            
┌────────┴────────┐                                                         ┌────────┴────────┐                                                         ┌────────┴────────┐                                                         
│      WINDOW     │                                                         │      WINDOW     │                                                         │      WINDOW     │                                                         
│   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         
│avg(sum(cs_sales_│                                                         │avg(sum(cs_sales_│                                                         │avg(sum(cs_sales_│                                                         
│  price)) OVER   │                                                         │  price)) OVER   │                                                         │  price)) OVER   │                                                         
│  (PARTITION BY  │                                                         │  (PARTITION BY  │                                                         │  (PARTITION BY  │                                                         
│ i_category,...  │                                                         │ i_category,...  │                                                         │ i_category,...  │                                                         
│ cc_name, d_year)│                                                         │ cc_name, d_year)│                                                         │ cc_name, d_year)│                                                         
└────────┬────────┘                                                         └────────┬────────┘                                                         └────────┬────────┘                                                                            
┌────────┴────────┐                                                         ┌────────┴────────┐                                                         ┌────────┴────────┐                                                         
│  HASH_GROUP_BY  │                                                         │  HASH_GROUP_BY  │                                                         │  HASH_GROUP_BY  │                                                         
│   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         
│        #0       │                                                         │        #0       │                                                         │        #0       │                                                         
│        #1       │                                                         │        #1       │                                                         │        #1       │                                                         
│        #2       │                                                         │        #2       │                                                         │        #2       │                                                         
│        #3       │                                                         │        #3       │                                                         │        #3       │                                                         
│        #4       │                                                         │        #4       │                                                         │        #4       │                                                         
│     sum(#5)     │                                                         │     sum(#5)     │                                                         │     sum(#5)     │                                                         
└────────┬────────┘                                                         └────────┬────────┘                                                         └────────┬────────┘                                                                            
┌────────┴────────┐                                                         ┌────────┴────────┐                                                         ┌────────┴────────┐                                                         
│    PROJECTION   │                                                         │    PROJECTION   │                                                         │    PROJECTION   │                                                         
│   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         
│    i_category   │                                                         │    i_category   │                                                         │    i_category   │                                                         
│     i_brand     │                                                         │     i_brand     │                                                         │     i_brand     │                                                         
│     cc_name     │                                                         │     cc_name     │                                                         │     cc_name     │                                                         
│      d_year     │                                                         │      d_year     │                                                         │      d_year     │                                                         
│      d_moy      │                                                         │      d_moy      │                                                         │      d_moy      │                                                         
│  cs_sales_price │                                                         │  cs_sales_price │                                                         │  cs_sales_price │                                                         
└────────┬────────┘                                                         └────────┬────────┘                                                         └────────┬────────┘                                                                            
┌────────┴────────┐                                                         ┌────────┴────────┐                                                         ┌────────┴────────┐                                                         
│    HASH_JOIN    │                                                         │    HASH_JOIN    │                                                         │    HASH_JOIN    │                                                         
│   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         
│      INNER      │                                                         │      INNER      │                                                         │      INNER      │                                                         
│   cs_item_sk =  │                                                         │   cs_item_sk =  │                                                         │   cs_item_sk =  │                                                         
│     i_item_sk   ├───────────────────────────────────────────────┐         │     i_item_sk   ├───────────────────────────────────────────────┐         │     i_item_sk   ├───────────────────────────────────────────────┐         
│  EC = 143997928 │                                               │         │  EC = 143997928 │                                               │         │  EC = 143997928 │                                               │         
│     .000000     │                                               │         │     .000000     │                                               │         │     .000000     │                                               │         
│ COST = 431993784│                                               │         │ COST = 431993784│                                               │         │ COST = 431993784│                                               │         
│     .000000     │                                               │         │     .000000     │                                               │         │     .000000     │                                               │         
└────────┬────────┘                                               │         └────────┬────────┘                                               │         └────────┬────────┘                                               │                            
┌────────┴────────┐                                      ┌────────┴────────┐┌────────┴────────┐                                      ┌────────┴────────┐┌────────┴────────┐                                      ┌────────┴────────┐
│    HASH_JOIN    │                                      │   PARQUET_SCAN  ││    HASH_JOIN    │                                      │   PARQUET_SCAN  ││    HASH_JOIN    │                                      │   PARQUET_SCAN  │
│   ─ ─ ─ ─ ─ ─   │                                      │   ─ ─ ─ ─ ─ ─   ││   ─ ─ ─ ─ ─ ─   │                                      │   ─ ─ ─ ─ ─ ─   ││   ─ ─ ─ ─ ─ ─   │                                      │   ─ ─ ─ ─ ─ ─   │
│      INNER      │                                      │    i_item_sk    ││      INNER      │                                      │    i_item_sk    ││      INNER      │                                      │    i_item_sk    │
│cs_call_center_sk│                                      │     i_brand     ││cs_call_center_sk│                                      │     i_brand     ││cs_call_center_sk│                                      │     i_brand     │
│ = cc_call_center│                                      │    i_category   ││ = cc_call_center│                                      │    i_category   ││ = cc_call_center│                                      │    i_category   │
│       _sk       ├────────────────────────────┐         │    EC=202300    ││       _sk       ├────────────────────────────┐         │    EC=202300    ││       _sk       ├────────────────────────────┐         │    EC=202300    │
│  EC = 143997928 │                            │         │                 ││  EC = 143997928 │                            │         │                 ││  EC = 143997928 │                            │         │                 │
│     .000000     │                            │         │                 ││     .000000     │                            │         │                 ││     .000000     │                            │         │                 │
│ COST = 287995856│                            │         │                 ││ COST = 287995856│                            │         │                 ││ COST = 287995856│                            │         │                 │
│     .000000     │                            │         │                 ││     .000000     │                            │         │                 ││     .000000     │                            │         │                 │
└────────┬────────┘                            │         └─────────────────┘└────────┬────────┘                            │         └─────────────────┘└────────┬────────┘                            │         └─────────────────┘                   
┌────────┴────────┐                   ┌────────┴────────┐                   ┌────────┴────────┐                   ┌────────┴────────┐                   ┌────────┴────────┐                   ┌────────┴────────┐                   
│    HASH_JOIN    │                   │   PARQUET_SCAN  │                   │    HASH_JOIN    │                   │   PARQUET_SCAN  │                   │    HASH_JOIN    │                   │   PARQUET_SCAN  │                   
│   ─ ─ ─ ─ ─ ─   │                   │   ─ ─ ─ ─ ─ ─   │                   │   ─ ─ ─ ─ ─ ─   │                   │   ─ ─ ─ ─ ─ ─   │                   │   ─ ─ ─ ─ ─ ─   │                   │   ─ ─ ─ ─ ─ ─   │                   
│      INNER      │                   │cc_call_center_sk│                   │      INNER      │                   │cc_call_center_sk│                   │      INNER      │                   │cc_call_center_sk│                   
│cs_sold_date_sk =│                   │     cc_name     │                   │cs_sold_date_sk =│                   │     cc_name     │                   │cs_sold_date_sk =│                   │     cc_name     │                   
│     d_date_sk   ├─────────┐         │      EC=30      │                   │     d_date_sk   ├─────────┐         │      EC=30      │                   │     d_date_sk   ├─────────┐         │      EC=30      │                   
│  EC = 143997928 │         │         │                 │                   │  EC = 143997928 │         │         │                 │                   │  EC = 143997928 │         │         │                 │                   
│     .000000     │         │         │                 │                   │     .000000     │         │         │                 │                   │     .000000     │         │         │                 │                   
│ COST = 143997928│         │         │                 │                   │ COST = 143997928│         │         │                 │                   │ COST = 143997928│         │         │                 │                   
│     .000000     │         │         │                 │                   │     .000000     │         │         │                 │                   │     .000000     │         │         │                 │                   
└────────┬────────┘         │         └─────────────────┘                   └────────┬────────┘         │         └─────────────────┘                   └────────┬────────┘         │         └─────────────────┘                                      
┌────────┴────────┐┌────────┴────────┐                                      ┌────────┴────────┐┌────────┴────────┐                                      ┌────────┴────────┐┌────────┴────────┐                                      
│   PARQUET_SCAN  ││      FILTER     │                                      │   PARQUET_SCAN  ││      FILTER     │                                      │   PARQUET_SCAN  ││      FILTER     │                                      
│   ─ ─ ─ ─ ─ ─   ││   ─ ─ ─ ─ ─ ─   │                                      │   ─ ─ ─ ─ ─ ─   ││   ─ ─ ─ ─ ─ ─   │                                      │   ─ ─ ─ ─ ─ ─   ││   ─ ─ ─ ─ ─ ─   │                                      
│ cs_sold_date_sk ││ ((d_year = 1999)│                                      │ cs_sold_date_sk ││ ((d_year = 1999)│                                      │ cs_sold_date_sk ││ ((d_year = 1999)│                                      
│cs_call_center_sk││   OR ((d_year = │                                      │cs_call_center_sk││   OR ((d_year = │                                      │cs_call_center_sk││   OR ((d_year = │                                      
│    cs_item_sk   ││ 1998) AND (...  │                                      │    cs_item_sk   ││ 1998) AND (...  │                                      │    cs_item_sk   ││ 1998) AND (...  │                                      
│  cs_sales_price ││ 12)) OR ((d...  │                                      │  cs_sales_price ││ 12)) OR ((d...  │                                      │  cs_sales_price ││ 12)) OR ((d...  │                                      
│   EC=143997928  ││ 2000) AND (d_moy│                                      │   EC=143997928  ││ 2000) AND (d_moy│                                      │   EC=143997928  ││ 2000) AND (d_moy│                                      
│                 ││      = 1)))     │                                      │                 ││      = 1)))     │                                      │                 ││      = 1)))     │                                      
└─────────────────┘└────────┬────────┘                                      └─────────────────┘└────────┬────────┘                                      └─────────────────┘└────────┬────────┘                                                         
                   ┌────────┴────────┐                                                         ┌────────┴────────┐                                                         ┌────────┴────────┐                                      
                   │   PARQUET_SCAN  │                                                         │   PARQUET_SCAN  │                                                         │   PARQUET_SCAN  │                                      
                   │   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                                         │   ─ ─ ─ ─ ─ ─   │                                      
                   │    d_date_sk    │                                                         │    d_date_sk    │                                                         │    d_date_sk    │                                      
                   │      d_year     │                                                         │      d_year     │                                                         │      d_year     │                                      
                   │      d_moy      │                                                         │      d_moy      │                                                         │      d_moy      │                                      
                   │     EC=40590    │                                                         │     EC=40590    │                                                         │     EC=40590    │                                      
                   └─────────────────┘                                                         └─────────────────┘                                                         └─────────────────┘                                                         

